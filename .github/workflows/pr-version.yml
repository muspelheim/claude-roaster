name: PR Version Preview

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  version-preview:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get Current Version
        id: current
        run: |
          echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Analyze PR for Version Bump
        id: analyze
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"

          # Determine bump type from PR title (conventional commits style)
          if echo "$PR_TITLE" | grep -qiE "^(breaking|major)(\(.+\))?:"; then
            echo "type=major" >> $GITHUB_OUTPUT
            echo "emoji=ðŸš¨" >> $GITHUB_OUTPUT
          elif echo "$PR_TITLE" | grep -qiE "^feat(\(.+\))?:"; then
            echo "type=minor" >> $GITHUB_OUTPUT
            echo "emoji=âœ¨" >> $GITHUB_OUTPUT
          else
            echo "type=patch" >> $GITHUB_OUTPUT
            echo "emoji=ðŸ”§" >> $GITHUB_OUTPUT
          fi

      - name: Calculate New Version
        id: new
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          TYPE="${{ steps.analyze.outputs.type }}"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          case $TYPE in
            major) NEW_VERSION="$((MAJOR + 1)).0.0" ;;
            minor) NEW_VERSION="${MAJOR}.$((MINOR + 1)).0" ;;
            patch) NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))" ;;
          esac

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const emoji = '${{ steps.analyze.outputs.emoji }}';
            const bumpType = '${{ steps.analyze.outputs.type }}';
            const currentVersion = '${{ steps.current.outputs.version }}';
            const newVersion = '${{ steps.new.outputs.version }}';

            const body = `## ${emoji} Version Preview

            When this PR is merged, the version will be automatically bumped:

            | Current | â†’ | New | Bump Type |
            |---------|---|-----|-----------|
            | \`${currentVersion}\` | â†’ | \`${newVersion}\` | **${bumpType}** |

            ### Version Bump Rules
            - \`breaking:\` or \`major:\` prefix â†’ **major** bump (x.0.0)
            - \`feat:\` prefix â†’ **minor** bump (0.x.0)
            - Other commits â†’ **patch** bump (0.0.x)

            ### Files Updated on Merge
            - \`package.json\`
            - \`.claude-plugin/plugin.json\`
            - \`src/constants.ts\`

            ---
            <sub>ðŸ¤– Automated by version-bump workflow</sub>`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Version Preview')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
